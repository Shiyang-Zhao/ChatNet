{% extends 'base.html' %}
{% load static %}
{% load crispy_forms_tags %}
{% block title %}{{ post.title }}{% endblock %}

{% block content %}
<div class="container mt-5">

    <h2>{{ post.title }}</h2> <!-- Display the post title -->
    <p>
        By {{ post.author }} on {{ post.date_posted|date:"F j, Y, g:i a" }}
    </p>

    <p>{{ post.content }}</p> <!-- Display the full content -->

    {% if post.file %}
    <div>
        <p>Download the attached file:</p>
        <a href="{{ post.file.url }}">{{ post.file.name }}</a> <!-- File download link -->
        <p>File type: {{ post.extension }}</p> <!-- Display the file extension -->
    </div>
    {% endif %}

    <p><strong>Likes:</strong> {{ post.likes }}</p>
    <p><strong>Comments:</strong> {{ post.comments_count }}</p>
    <p><strong>Views:</strong> {{ post.views }}</p>

    {% if request.user == post.author %}
    <div class="post-actions">
        <a class="btn btn-warning" href="{% url 'post-update' pk=post.pk %}">Edit</a> <!-- Link to update post -->
        <form method="post" action="{% url 'post-delete' pk=post.pk %}">
            {% csrf_token %}
            <button type="submit" class="btn btn-danger">Delete</button> <!-- Button to delete post -->
        </form>
    </div>
    {% endif %}

    <div>
        <button type="submit" class="btn btn-primary">Save</button>
    </div>
    <!-- Comment Form with Crispy Forms -->
    <h3>Leave a Comment</h3>
    <form method="post" action="{% url 'comment-create' pk=post.pk %}">
        {% csrf_token %} <!-- CSRF protection -->
        {{ comment_create_form|crispy }} <!-- Crispy Forms rendering -->
        <button type="submit" class="btn btn-primary">Submit</button> <!-- Submit button -->
    </form>

    <!-- Display existing comments -->
    <h3>Comments</h3>
    {% if parent_comments %}
    <ul class="list-group">
        {% for parent_comment in parent_comments %}
        <li class="list-group-item">
            <p>
                <strong>
                    {{ parent_comment.author.username }}
                </strong>
                on {{ parent_comment.date_posted|date:"F j, Y, g:i a" }}
            </p>
            <p>{{ parent_comment.content }}</p>

            <!-- Display a form to reply to this comment -->
            <h4>Reply</h4>
            <form method="post" action="{% url 'reply-create' post_pk=post.pk parent_comment_pk=parent_comment.pk %}">
                {% csrf_token %}
                {{ reply_create_form|crispy }}
                <button type="submit" class="btn btn-primary">Submit Reply</button>
            </form>

            {% include 'posts/nested_comment_form.html' with replies=parent_comment.children %}
        </li>
        {% endfor %}
    </ul>
    {% else %}
    <p>No comments yet.</p>
    {% endif %}
</div>
{% endblock %}